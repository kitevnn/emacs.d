* ğŸ”¨ .emacs.d

** ğŸ’¡ Startup

[[file:archive/Startup1.png]]

[[file:archive/Startup2.png]]

*** ğŸ¥• åŸºæœ¬çš„ä¿¡æ¯

| åºå· | ä¿¡æ¯        | è§£é‡Š                 |
|------+-------------+----------------------|
|    1 | ç¯å¢ƒ        | WSL2(2.5.9.0)        |
|    2 | OSå‘è¡Œç‰ˆ    | WSL-archlinux 2.4.13 |
|    3 | Emacså‘è¡Œç‰ˆ | GNU Emacs            |
|    4 | åˆ†æ”¯        | emacs-feature-igc    |

*** ğŸª“ å¼€å¯çš„ç‰¹æ€§

#+begin_src sh
CFLAGS="-fmax-errors=1000" ./configure \
    --sysconfdir=/etc \                   # é…ç½®æ–‡ä»¶é»˜è®¤å®‰è£…åˆ° /etc
    --prefix=/usr \                       # å®‰è£…æ ¹è·¯å¾„ä¸º /usrï¼ˆä¸æ˜¯ /usr/localï¼‰
    --libexecdir=/usr/lib \               # å†…éƒ¨ helper ç¨‹åºè£…åˆ° /usr/lib
    --localstatedir=/var \                # æœ¬åœ°å˜é‡æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ç¼“å­˜ï¼‰è®¾ä¸º /var
    --disable-build-details \             # ä¸å†™å…¥æ„å»ºæ—¶é—´/ä¸»æœºä¿¡æ¯ï¼Œæé«˜æ„å»ºå¯é‡ç°æ€§
    --with-harfbuzz \                     # å¯ç”¨ HarfBuzzï¼Œæå‡å­—ä½“æ¸²æŸ“è´¨é‡ï¼ˆæ”¯æŒ ligaturesï¼‰
    --with-libsystemd \                   # å¯ç”¨å¯¹ systemd çš„æ”¯æŒ
    --with-modules \                      # å¯ç”¨ Emacs åŠ¨æ€æ¨¡å—æ”¯æŒï¼ˆæ”¯æŒå¤–éƒ¨æ¨¡å—ï¼‰
    --with-x-toolkit=gtk3 \               # ä½¿ç”¨ GTK3 å›¾å½¢ç•Œé¢ï¼ˆX11ï¼‰
    --with-mps=yes \                      # å¯ç”¨ memory pool systemï¼ˆEmacs GC çš„æ›¿ä»£å®ç°ï¼‰
    --with-gnutls=ifavailable \           # å¯ç”¨ GnuTLS ç½‘ç»œå®‰å…¨åº“ï¼ˆSSL/TLSï¼‰ï¼Œå¦‚æœæœ‰çš„è¯ï¼ˆåœ¨ä»elpaè·å–åŒ…å®‰è£…åŠæ›´æ–°éœ€è¦ç”¨åˆ°ï¼‰
    --with-rsvg \                         # å¼€å¯ rsvgï¼ˆSVG æ”¯æŒï¼‰
    --with-imagemagick \                  # å¼€å¯ ImageMagick æ”¯æŒ
    --with-tree-sitter=ifavailable \      # ä½¿ç”¨ tree-sitterï¼ˆè¯­æ³•é«˜äº®å¼•æ“ï¼‰å¦‚æœå¯ç”¨
    'CFLAGS=-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fcf-protection -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -g -ffile-prefix-map=/build/emacs/src=/usr/src/debug/emacs -flto=auto' \
    'LDFLAGS=-Wl,-O1 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,-z,pack-relative-relocs -flto=auto'   
#+end_src

** ğŸ‘ GNU Emacså¿«æ·é”®é£æ ¼

| åºå· | å¿«æ·é”®å‰ç¼€(prefix-key) | è§£é‡Šæ„ä¹‰                       |
|------+-----------------------+-------------------------------|
|    1 | ~C-z C-z~             | *<custom>*                    |
|    2 | ~C-z C-p~             | *<p>* rocess                  |
|    3 | ~C-z C-s~             | *<s>* witch window            |
|    4 | ~C-z C-t~             | *<t>* heme                    |
|    5 | ~C-z C-b~             | *<b>* uffer                   |
|    6 | ~C-z C-w~             | resize *<w>* indow            |
|    7 | ~C-z C-d~             | *<d>* ashboard & *<d>* irvish |
|    8 | ~C-z C-x~             | te *<x>* t                    |
|    9 | ~C-z C-n~             | de *<n>* ote                  |
|   10 | ~C-z C-a~             | *<a>* genda                   |
|   11 | ~C-z C-o~             | *<o>* rg-mode                 |
|   12 | ~C-z C-m~             | e *<m>* ms                    |

** ğŸ”” MEME

[[https://github.com/kitevnn/dotfiles-archlinux/blob/main/MEME/EmacsTheTrueEditor.png][EmacsTheTrueEditor]]

** ğŸ”‘ æœ‰è¶£çš„å®ç°

*** 1. GNU Emacsæ€»ä½¿ç”¨æ—¶é•¿

ä» ~2025å¹´ 01æœˆ 26æ—¥ æ˜ŸæœŸæ—¥ 13:55:28 CST~ é‡æ–°å¼€å§‹ç´¯è®¡

#+begin_quote
Accompanying With GNU Emacs: 202 hours, 59 minutes, 49 seconds
#+end_quote

å®ç°è¿‡ç¨‹(å±•ç¤ºä»£ç ï¼Œä»è€Œæ¥è¯æ˜æˆ‘è‡ªå·±å¹¶æ²¡æœ‰ä¹±å†™æ—¶é—´ä¸Šå»ï¼Œå› ä¸ºæ¯æ¬¡çš„æ—¶é—´éƒ½ä¾èµ–äº ~(emacs-uptime)~ æ­¤elå‡½æ•°æ¥è·å–)

*bashæ–¹é¢*
#+begin_src sh
  #!/bin/bash

  # åŸºæœ¬è·¯å¾„é…ç½®
  user="une"
  path1=".config/emacs/archive"
  path2=".config/emacs/elisp/site-lisp/sh"
  filename="uptime"

  # å­˜å‚¨æ–‡ä»¶è·¯å¾„
  file1="/home/${user}/${path1}/${filename}"
  file2="/home/${user}/${path2}/${filename}"

  # åˆå§‹åŒ–æ€»æ—¶é—´
  total_seconds=0

  # é€è¡Œè¯»å–æ–‡ä»¶å†…å®¹
  while IFS= read -r line; do
    # åŒ¹é…å¹¶æå–å°æ—¶ã€åˆ†é’Ÿå’Œç§’
    if [[ "$line" =~ Uptime:\ ([0-9]+)\ hours?,\ ([0-9]+)\ minutes?,\ ([0-9]+)\ seconds? ]]; then
      hours=${BASH_REMATCH[1]}
      minutes=${BASH_REMATCH[2]}
      seconds=${BASH_REMATCH[3]}
    elif [[ "$line" =~ Uptime:\ ([0-9]+)\ minutes?,\ ([0-9]+)\ seconds? ]]; then
      hours=0
      minutes=${BASH_REMATCH[1]}
      seconds=${BASH_REMATCH[2]}
    elif [[ "$line" =~ Uptime:\ ([0-9]+)\ seconds? ]]; then
      hours=0
      minutes=0
      seconds=${BASH_REMATCH[1]}
    else
      # å¦‚æœä¸åŒ¹é…ä»»ä½•å·²çŸ¥æ ¼å¼ï¼Œè·³è¿‡è¿™è¡Œ
      continue
    fi

    # å°†æ—¶é—´è½¬æ¢ä¸ºç§’
    total_seconds=$((total_seconds + hours * 3600 + minutes * 60 + seconds))

  done < "$file1"

  # å¯é€‰ï¼šå°†ç§’æ•°è½¬æ¢ä¸ºå°æ—¶:åˆ†é’Ÿ:ç§’ æ ¼å¼
  total_hours=$((total_seconds / 3600))
  remaining_minutes=$(((total_seconds % 3600) / 60))
  remaining_seconds=$((total_seconds % 60))

  # è¾“å‡ºæ€»æ—¶é—´
  echo "Accompanying With GNU Emacs: $total_hours hours, $remaining_minutes minutes, $remaining_seconds seconds"
  echo "Accompanying With GNU Emacs: $total_hours hours, $remaining_minutes minutes, $remaining_seconds seconds" > "$file2"
#+end_src

*elispæ–¹é¢*
#+begin_src elisp
  ;; =======================================
  ;; è·¯å¾„å˜é‡ (~/.config/emacs/elisp/basic/basic-file.el)
  ;; =======================================
  (defvar directory-site-lisp               "elisp/site-lisp/sh/")                     ; emacsé…ç½®æ–‡ä»¶è·¯å¾„çš„modelineéƒ¨åˆ†

  ;; =======================================
  ;; æ‰‹åŠ¨æ›´æ–°å·²ä½¿ç”¨çš„GNU Emacsç´¯åŠ æ—¶é•¿ (~/.config/emacs/elisp/custom/custom-defun.el)
  ;; =======================================
  (defun my-save-emacs-uptime ()
    "é€šè¿‡è®¾ç½®é’©å­hooksï¼Œåœ¨æ¯æ¬¡é€€å‡ºEmacsåï¼Œè‡ªåŠ¨ä¿å­˜emacs-uptimeæ•°æ®åˆ°æŒ‡å®šæ–‡ä»¶å†…"
    (let ((uptime (emacs-uptime)))
      (with-temp-buffer
        (insert (format "Uptime: %s\n" uptime))
        (append-to-file (point-min) (point-max)  (concat user-emacs-directory directory-emacs-archive "uptime")))))

  (defun my-show-emacs-uptime ()
    "é€šè¿‡site-lispçš„shè„šæœ¬å®ç°ï¼Œè·å–Emacsçš„ç´¯è®¡ä½¿ç”¨æ€»æ—¶é•¿"
    (interactive)
    (let ((uptime-output
           (string-trim (shell-command-to-string
                         (concat user-emacs-directory directory-site-lisp "calculate-uptime.sh")))))
      (insert uptime-output)))


  ;; =======================================
  ;; æ›´æ–° calculate-uptime.sh è„šæœ¬è¾“å‡ºçš„é’©å­ (~/.config/emacs/elisp/hooks/hooks-hook.el)
  ;; =======================================
  (add-hook 'kill-emacs-hook 'my-save-emacs-uptime)                            ; åœ¨é€€å‡ºEmacsæ—¶ä¿å­˜å½“å‰uptime
#+end_src

*** 2. åœ¨modelineä¸Šå±•ç¤º [è®®ç¨‹æ•°é‡] çš„ä¿¡æ¯

*å¯èƒ½å“ªé‡Œä¼šå‡ºç°ä¸€ç‚¹ç‚¹é”™è¯¯ï¼Œä½†å¤§è‡´ä¸Šçš„é€»è¾‘å°±æ˜¯è¿™æ ·*

#+begin_src elisp
;; ==============================================
;; è®¾ç½®org-modeå¿…è¦çš„å…³é”®è¯
;; ==============================================
(setq org-todo-keywords
      '((sequence "TODO" "DOING" "WAIT" "DONE" "MY")))

  ;; ==============================================
  ;; ç”Ÿäº§æ•°æ®çš„è¿‡ç¨‹
  ;; ==============================================
  ;; å¿…è¦çš„å˜é‡ä¿¡æ¯
  (defvar file-org-agenda-files               "/home/user/directory-114514/1919810.org" "[æ–‡ä»¶]: å¿…é¡»æ˜¯orgæ–‡ä»¶ï¼Œå› ä¸ºéœ€è¦ä½¿ç”¨org-mode")
  (defvar modeline-agenda-todo-count 0)
  (defvar modeline-agenda-doing-count 0)
  (defvar modeline-agenda-wait-count 0)
  (defvar modeline-agenda-file-name "")

  ;; è®¾ç½®å‡½æ•°
  (defun kivnn/count-agenda-file-tasks (file-path)
    "æ›´æ–°æŒ‡å®šè·¯å¾„è®®ç¨‹æ–‡ä»¶çš„agendaä¿¡æ¯"
    (interactive)
    (setq modeline-agenda-todo-count 0)
    (setq modeline-agenda-doing-count 0)
    (setq modeline-agenda-wait-count 0)
    (setq modeline-agenda-file-name (file-name-nondirectory file-path))
    ;; æ‰“å¼€ä¸´æ—¶buffer
    (with-temp-buffer
      (insert-file-contents file-path)
      (goto-char (point-min))
      (while (re-search-forward org-heading-regexp nil t)
        (let ((headline (match-string 0)))
          (cond
           ((string-match-p "\\*+ TODO" headline) (setq modeline-agenda-todo-count (1+ modeline-agenda-todo-count)))
           ((string-match-p "\\*+ DOING" headline) (setq modeline-agenda-doing-count (1+ modeline-agenda-doing-count)))
           ((string-match-p "\\*+ WAIT" headline) (setq modeline-agenda-wait-count (1+ modeline-agenda-wait-count))))))))

  ;; è®©ä¸Šè¿°å‡½æ•°åªå¯¹ç‰¹å®šæŒ‡å®šæ–‡ä»¶ç”Ÿæ•ˆ
  ;; ä»è€Œç»Ÿè®¡æ‰€æœ‰çš„ "*+ TODOã€*+ DOINGã€*+ WAIT" çš„æ ‡é¢˜æ•°é‡
  ;; å¹¶æ›´æ–°åˆ° "modeline-agenda-todo-count modeline-agenda-doing-count modeline-agenda-wait-count" å˜é‡ä¸Š
  (defun kivnn/update-modeline-agenda-file-tasks ()
    "ç»Ÿè®¡æŒ‡å®šæ–‡ä»¶2025.orgçš„ä»»åŠ¡"
    (kivnn/count-agenda-file-tasks file-org-agenda-files))


  ;; ==============================================
  ;; å±•ç¤ºæ•°æ®çš„è¿‡ç¨‹
  ;; ==============================================
  ;; å°† "modeline-agenda-todo-count modeline-agenda-doing-count modeline-agenda-wait-count" å˜é‡è®¾ç½®åœ¨modelineä¸Š
  (defun kivnn/update-modeline-with-all-scripts ()
    "æ˜¾ç¤ºmodelineä¿¡æ¯"
    (setq global-mode-string
          (list
           "  "
           (format "ó°„’ TODO %d " modeline-agenda-todo-count)
           (format "ó±¿ DOING %d " modeline-agenda-doing-count)
           (format "ó°• WAIT %d " modeline-agenda-wait-count)
           "- î˜³ "
           modeline-agenda-file-name))
    (setq-default mode-line-format
                  '("%e"
                    ;; a lot of things
                    global-mode-string
                    ;; a lot of things
                    )))

  ;; è‡ªåŠ¨ç‰ˆ
  (run-at-time "0 sec" 1800  'kivnn/update-modeline-agenda-file-tasks)   ; æ¯30åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡file-org-agenda-fileså˜é‡ çš„æŒ‡å®šæ–‡ä»¶çš„ "*+ TODOã€*+ DOINGã€*+ WAIT" çš„æ ‡é¢˜æ•°é‡

  ;; æ‰‹åŠ¨ç‰ˆ
  (defun kivnn/update-modeline-all-information ()
    "æ‰‹åŠ¨æ›´æ–°çŠ¶æ€æ ä¸Šçš„æ‰€æœ‰ä¿¡æ¯"
    (interactive)
    (kivnn/update-modeline-agenda-file-tasks) ; æ‰‹åŠ¨è¯»å– file-org-agenda-fileså˜é‡ çš„æŒ‡å®šæ–‡ä»¶çš„ "*+ TODOã€*+ DOINGã€*+ WAIT" çš„æ ‡é¢˜æ•°é‡
    (kivnn/update-modeline-with-all-scripts)) ; ç„¶åæ›´æ–°modelineçŠ¶æ€æ 

  ;; è®¾ç½®å¿«æ·é”®
  (global-set-key (kbd "C-114514")                   'kivnn/update-modeline-output-agenda-tasks)
#+end_src

*** 3. å»é™¤é¦–æ¬¡æ‰“å¼€çš„ ~*Message*~ ä¸ ~*scratch*~

#+begin_src elisp
  (setq message-log-max nil)

  (defun kivnn/dashboard-mode-hook ()
    "ä¿è¯ä¸€ç›´å…³é—­scratchï¼Œä¿è¯åªå…³é—­ç¬¬ä¸€æ¬¡Message"
    (setq-default kivnn/kill-scratch-buffer nil)
    (when (get-buffer "*scratch*") (kill-buffer "*scratch*"))
    (unless kivnn/kill-scratch-buffer
      (when (get-buffer "*Messages*")
        (kill-buffer "*Messages*")
        (setq-default kivnn/kill-scratch-buffer t))))

  (defun kivnn/view-echo-area-messages ()
    "è®¾ç½®message-log-maxå¹¶æ‰“å¼€*Message*çš„buffer"
    (interactive)
    (setq message-log-max 1000)
    (view-echo-area-messages))

  ;; è®¾ç½®å¿«æ·é”®
  (global-set-key (kbd "C-114514")                   'kivnn/view-echo-area-messages)
#+end_src

*** 4. é­”æ”¹org-latex-previewé»˜è®¤çš„dvipngå‘½ä»¤ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ xelatex-chineseå¤„ç†å¼•æ“

**** (1) dvipngæ–¹æ¡ˆ(dvi â†’ pngï¼Œ130 DPIï¼Œå­—ä½“æ€æºé›…é»‘CN(adobe-source-han-sans-cn-fonts))

#+begin_src sh
# C-h v dvipng-image-size-adjust
# (1.7 . 1.5)

# C-h v dvipng-latex-compiler
latex -interaction nonstopmode -output-directory %o %f

# C-h v dvipng-image-converter-dpi
# 130

# C-h v dvipng-image-converter
dvipng -D 130 -T tight -o %O %f

# C-h v dvipng-transparent-image-converter
convert -density 130 -background '#FFFFFF' -flatten -quality 100 %f %O
#+end_src

**** (2) xelatex-chineseæ–¹æ¡ˆ(pdf â†’ pngï¼Œä¸èƒ½å¼‚æ­¥æ¸²æŸ“ï¼Œå­—ä½“æ€æºé›…é»‘CN(adobe-source-han-sans-cn-fonts))

#+begin_src sh
# C-h v xelatex-chinese-latex-header
# "\\documentclass[11pt]{standalone}
#                               \\usepackage{fontspec}
#                               \\setmainfont{Source Han Sans CN}
#                               \\setsansfont{Source Han Sans CN}
#                               \\setmonofont{Source Han Sans CN}
#                               \\usepackage[usenames]{color}
#                               \\usepackage{amsmath}
#                               \\usepackage{extpfeil}
#                               \\pagestyle{empty}"

# C-h v xelatex-chinese-image-size-adjust
# (1.7 . 1.5)

# C-h v xelatex-chinese-latex-compiler
xelatex -interaction nonstopmode -output-directory %o %f

# C-h v xelatex-chinese-image-converter
convert -density 105 -background '#FFFFFF' -flatten -quality 100 %f %O
#+end_src

**** (3) é…ç½®æ–¹æ³•

å‘ç‚¹è¯´æ˜

#+begin_quote
  å¦‚æœæƒ³é€šè¿‡ [æŸå˜é‡] æ¥æ•´ä½“æ§åˆ¶LaTeXå›¾ç‰‡çš„èƒŒæ™¯é¢œè‰²çš„è¯
  é‚£ä¹ˆ dvipng å°±ä¸èƒ½åŠ ä¸Š -bg Transparent æˆ– -bg White çš„å‚æ•°
  å› ä¸º dvipng çš„æ­¤é¢œè‰²å‚æ•°ï¼Œä¼šè¦†ç›–åé¢çš„ imagemagick çš„é¢œè‰²è½¬æ¢
  å¯¼è‡´å°†æ¥åœ¨Emacsé‡Œé¢„è§ˆæ—¶ï¼Œé¢œè‰²ä¸€ç›´éƒ½å°†ä¼šæ˜¯ Transparent æˆ– White ç­‰é¢œè‰²
#+end_quote

é…ç½®æ–¹æ³•

#+begin_src elisp
;; =========================================================================================================
;;
;; è‡ªå®šä¹‰dvipngå¼•æ“
;;
;; =========================================================================================================
;; è®¾ç½®dvipngçš„è°ƒæ•´å›¾ç‰‡å¤§å°
(defvar dvipng-image-size-adjust
  (read (format "(%f . %f)"
                variable-latex-fragment-adjust-width
                variable-latex-fragment-adjust-height)))

;; è®¾ç½®latexç¼–è¯‘å™¨çš„ç”Ÿæˆdviæ–‡ä»¶çš„è¡Œä¸º
(defvar dvipng-latex-compiler
  (concat "latex"                         ; ä½¿ç”¨latexç¼–è¯‘å™¨æ¥ç”Ÿæˆ.dviæ–‡ä»¶
          " "
          "-interaction nonstopmode"      ; ç¼–è¯‘æ—¶é‡åˆ°é”™è¯¯ä¹Ÿä¸åœä¸‹ï¼Œç»§ç»­ç¼–è¯‘ï¼Œé˜²æ­¢Emacså› ä¸ºä¸€äº›ä¸Šå¤LaTeX2eå®åŒ…çš„é”™è¯¯è€Œå¡ä½
          " "
          "-output-directory %o"          ; åœ¨å½“å‰ç›®å½•çš„ä¸´æ—¶ç›®å½•ä¸‹ï¼Œè¾“å‡ºç¼–è¯‘å‡ºæ¥çš„äº§ç‰©æ–‡ä»¶
          " "
          "%f"                            ; Emacsä¸´æ—¶æ ¹æ®å½“å‰latex-fragmentç”Ÿæˆ.texæºæ–‡ä»¶ï¼Œå¹¶ä¼ å…¥åˆ°å‰é¢çš„ç¼–è¯‘å™¨æ¥ç¼–è¯‘
          ))

;; è®¾ç½®dvipngè½¬æ¢å›¾ç‰‡ç¨‹åºçš„ä»dviç”Ÿæˆåˆ°pngçš„è¡Œä¸º
(defvar dvipng-image-converter-dpi variable-ui-fonts-size)
(defvar dvipng-image-converter
  (concat
   "dvipng"                               ; å°†ä¹‹å‰å¾—åˆ°çš„dviæ–‡ä»¶ï¼Œè½¬æ¢ä¸ºpngçš„å¼•æ“ç¨‹åº
   " "
   (format "-D %d"
           dvipng-image-converter-dpi)    ; è®¾ç½®åˆ†è¾¨ç‡
   " "
   "-T tight"                             ; è‡ªåŠ¨è£å‰ªè¾¹ç¼˜ç©ºç™½ï¼Œé˜²æ­¢å‡ºç°å¤§é¢ç§¯ç©ºç™½åŒºåŸŸ
   " "
   "-o %O"                                ; åœ¨å½“å‰ç›®å½•çš„ä¸´æ—¶ç›®å½•ä¸‹ï¼Œè¾“å‡ºç¼–è¯‘å‡ºæ¥çš„äº§ç‰©æ–‡ä»¶
   " "
   "%f"                                   ; è¾“å…¥è¯»å–.dviæ–‡ä»¶ï¼Œæ¥åœ¨ä¸‹ä¸€æ­¥å»è½¬æ¢ä¸ºpngæ–‡ä»¶
   ))

;; è®¾ç½®imagemagickè½¬æ¢å›¾ç‰‡ç¨‹åºä»pngåˆ°æ›´è¿›ä¸€æ­¥çš„pngçš„è¡Œä¸º
(defvar dvipng-transparent-image-converter
  (concat
   "convert"                              ; convertä¹Ÿå°±æ˜¯imagemagick
   " "
   (format "-density %d"                  ; æ§åˆ¶åƒç´ å¯†åº¦
         variable-ui-fonts-size)
   " "
   (format "-background '%s'"             ; è®¾ç½®èƒŒæ™¯é¢œè‰²
           variable-latex-fragment-background)
   " "
   "-flatten"                             ; ç±»ä¼¼PSçš„åˆå¹¶å›¾å±‚ï¼Œéœ€è¦åœ¨-backgroundåé¢ä½¿ç”¨ï¼Œç›®çš„æ˜¯å°†é€æ˜åŒºåŸŸå˜æˆå¸¦RGBé€šé“çš„åŒºåŸŸ
   " "
   (format "-quality %d"                  ; PNG çš„å‹ç¼©è´¨é‡(å¯¹äº PNG å½±å“ä¸å¤§ï¼Œå¯¹ JPEG å¾ˆé‡è¦)
           variable-latex-fragment-quality)
   " "
   "%f"                                   ; è¾“å…¥è¯»å–.pngæ–‡ä»¶ï¼Œæ¥è½½ä¸‹ä¸€æ­¥å»è½¬æ¢ä¸ºmagickè¿™é‡Œè®¾ç½®å‡ºæ¥çš„pngæ–‡ä»¶
   " "
   "%O"                                   ; è¾“å‡ºmagickè¿™é‡Œè®¾ç½®å‡ºæ¥çš„pngæ–‡ä»¶çš„æ–‡ä»¶åå ä½ç¬¦
   ))


;; ========================================
;; dvipng: æ¸²æŸ“éutf-8ç‰‡æ®µå¼•æ“
;; ========================================
;; åˆ é™¤åŸæœ¬çš„
(setq org-preview-latex-process-alist
      (assq-delete-all 'dvipng org-preview-latex-process-alist))
;; æ·»åŠ è‡ªå·±çš„
(setq org-preview-latex-process-alist
      `((dvipng
        :programs ("latex" "dvipng" "convert")
        :description "dvi > png"
        :message "you need to install the programs: latex and dvipng."
        :image-input-type "dvi"
        :image-output-type "png"
        :image-size-adjust ,dvipng-image-size-adjust
        :latex-compiler (,dvipng-latex-compiler)
        :image-converter (,dvipng-image-converter)
        :transparent-image-converter (,dvipng-transparent-image-converter))))



;; =========================================================================================================
;;
;; è‡ªå®šä¹‰xelatex-chineseå¼•æ“
;;
;; =========================================================================================================
;; è®¾ç½®dvipngçš„è°ƒæ•´å›¾ç‰‡å¤§å°
(defvar xelatex-chinese-image-size-adjust
  (read (format "(%f . %f)"
                variable-latex-fragment-adjust-width
                variable-latex-fragment-adjust-height)))

;; è®¾ç½®xelatex-chineseçš„latexå¤´æ–‡ä»¶
(defvar xelatex-chinese-latex-header
  (format "\\documentclass[%s]{standalone}
                              \\usepackage{fontspec}
                              \\setmainfont{%s}
                              \\setsansfont{%s}
                              \\setmonofont{%s}
                              \\usepackage[usenames]{color}
                              \\usepackage{amsmath}
                              \\usepackage{extpfeil}
                              \\pagestyle{empty}"
          variable-latex-fragment-documentclass-base
          variable-ui-fonts-source
          variable-ui-fonts-source
          variable-ui-fonts-source))

;; è®¾ç½®xelatexç¼–è¯‘å™¨çš„ä»pdfç”Ÿæˆåˆ°pngçš„è¡Œä¸º
(defvar xelatex-chinese-latex-compiler
  (concat
   "xelatex"                                    ; ä½¿ç”¨xelatexç¼–è¯‘å™¨æ¥ç”Ÿæˆ.pdfæ–‡ä»¶
   " "
   "-interaction nonstopmode"                   ; ç¼–è¯‘æ—¶é‡åˆ°é”™è¯¯ä¹Ÿä¸åœä¸‹ï¼Œç»§ç»­ç¼–è¯‘ï¼Œé˜²æ­¢Emacså› ä¸ºä¸€äº›ä¸Šå¤LaTeX2eå®åŒ…çš„é”™è¯¯è€Œå¡ä½
   " "
   "-output-directory %o"                       ; åœ¨å½“å‰ç›®å½•çš„ä¸´æ—¶ç›®å½•ä¸‹ï¼Œè¾“å‡ºç¼–è¯‘å‡ºæ¥çš„äº§ç‰©æ–‡ä»¶
   " "
   "%f"                                         ; Emacsä¸´æ—¶æ ¹æ®å½“å‰latex-fragmentç”Ÿæˆ.texæºæ–‡ä»¶ï¼Œå¹¶ä¼ å…¥åˆ°å‰é¢çš„ç¼–è¯‘å™¨æ¥ç¼–è¯‘
   ))

;; è®¾ç½®imagemagickè½¬æ¢å›¾ç‰‡ç¨‹åºä»pngåˆ°æ›´è¿›ä¸€æ­¥çš„pngçš„è¡Œä¸º
(defvar xelatex-chinese-image-converter
  (concat
   "convert"                                    ; convertä¹Ÿå°±æ˜¯imagemagick
   " "
   (format "-density %d"
           (- variable-ui-fonts-size 25))       ; æ§åˆ¶åƒç´ å¯†åº¦
   " "
   (format "-background '%s'"
           variable-latex-fragment-background)  ; è®¾ç½®èƒŒæ™¯é¢œè‰²
   " "
   "-flatten"                                   ; ç±»ä¼¼PSçš„åˆå¹¶å›¾å±‚ï¼Œéœ€è¦åœ¨-backgroundåé¢ä½¿ç”¨ï¼Œç›®çš„æ˜¯å°†é€æ˜åŒºåŸŸå˜æˆå¸¦RGBé€šé“çš„åŒºåŸŸ
   " "
   (format "-quality %d"
           variable-latex-fragment-quality)     ; PNG çš„å‹ç¼©è´¨é‡(å¯¹äº PNG å½±å“ä¸å¤§ï¼Œå¯¹ JPEG å¾ˆé‡è¦)
   " "
   "%f"                                        ; è¾“å…¥è¯»å–.pngæ–‡ä»¶ï¼Œæ¥è½½ä¸‹ä¸€æ­¥å»è½¬æ¢ä¸ºmagickè¿™é‡Œè®¾ç½®å‡ºæ¥çš„pngæ–‡ä»¶
   " "
   "%O"                                        ; è¾“å‡ºmagickè¿™é‡Œè®¾ç½®å‡ºæ¥çš„pngæ–‡ä»¶çš„æ–‡ä»¶åå ä½ç¬¦
   ))


;; ========================================
;; xelatex-chinese: æ¸²æŸ“utf-8ç‰‡æ®µå¼•æ“
;; ========================================
(add-to-list 'org-preview-latex-process-alist
             `(xelatex-chinese
               :programs ("xelatex" "convert")
               :description "pdf > png"
               :message "you need to install the programs: xelatex and dvipng."
               :image-input-type "pdf"
               :image-output-type "png"
               :image-size-adjust ,xelatex-chinese-image-size-adjust
               :latex-header ,xelatex-chinese-latex-header
               :latex-compiler (,xelatex-chinese-latex-compiler)
               :image-converter (,xelatex-chinese-image-converter)))



;; =========================================================================================================
;;
;; æ‰‹åŠ¨é€‰æ‹© org-preview-latex-default-process æ¥è‡ªç”±åœ°åˆ‡æ¢åœ¨ dvipng(é»˜è®¤) ä¸ xelatex-chinese(è‡ªå®šä¹‰) å¤„ç†å¼•æ“
;;
;; =========================================================================================================
  (defvar variable-latex-fragment-left-bound  "\\\("                                          "[å˜é‡]: latex-fragmentçš„å·¦è¾¹ç•Œ")
  (defvar variable-latex-fragment-right-bound "\\\)"                                          "[å˜é‡]: latex-fragmentçš„å³è¾¹ç•Œ")

  (defun kivnn/org-latex-preview-format ()
    "æ¸²æŸ“ä¸­æ–‡LaTeXç‰‡æ®µä¹‹å‰çš„æ ¼å¼åŒ–"
    (interactive)
    ;; æ‰¾åˆ°å·¦è¾¹ç•Œ
    (let ((thing (thing-at-point 'line t)))
      (if (and thing (string-match (concat variable-latex-fragment-left-bound ".*" variable-latex-fragment-right-bound) thing))
          (search-backward variable-latex-fragment-left-bound nil t)
        (message "no such equation, please check again...")))
    (forward-char 2)
    (delete-all-space)
    ;; æ‰¾åˆ°å³è¾¹ç•Œ
    (let ((thing (thing-at-point 'line t)))
      (if (and thing (string-match (concat variable-latex-fragment-left-bound ".*" variable-latex-fragment-right-bound) thing))
          (search-forward variable-latex-fragment-right-bound nil t)
        (message "no such equation, please check again...")))
    (backward-char 3)
    (delete-all-space))

  (defun kivnn/org-latex-preview-engine ()
    "æ¸²æŸ“ä¸­æ–‡LaTeXç‰‡æ®µ"
    (interactive)
    (let* ((latex-code (thing-at-point 'line t))
           (is-utf8 (and latex-code
                         (string-match (concat variable-latex-fragment-left-bound ".*" variable-latex-fragment-right-bound) latex-code)
                         (string-match-p "[^\x00-\x7F]" latex-code))))
      (if s-utf8
                                          ; å¦‚æœåŒ…å« UTF-8 å­—ç¬¦ï¼Œå°±ä½¿ç”¨ xelatex-chinese å¼•æ“
          progn
        (setq org-preview-latex-default-process 'xelatex-chinese)
        (message "ç›®å‰ä½¿ç”¨äº†xelatex-chineseå¼•æ“æ¸²æŸ“æ­¤LaTeXç‰‡æ®µ"))
      ;; å¦‚æœä¸åŒ…å« UTF-8 å­—ç¬¦ï¼Œå°±ä½¿ç”¨ dvipngã€dvisvgmã€imagemagick å¼•æ“
      (setq org-preview-latex-default-process 'dvipng)
      (message "ç›®å‰ä½¿ç”¨äº†org-modeé»˜è®¤çš„dvipngã€dvisvgmã€imagemagickå¼•æ“æ¸²æŸ“æ­¤LaTeXç‰‡æ®µ"))
    (org-latex-preview)
    ;; æ¯æ¬¡æ‰§è¡Œå®Œæ¯•åéƒ½æ¢å¤ä¸º dvipngã€dvisvgmã€imagemagick å¼•æ“
    (setq org-preview-latex-default-process 'dvipng)
    (message "Creating Latex previews in section...(and recover dvipng...) done.")))

  (defun kivnn/org-latex-preview ()
    "æ— è§†fontspecåŒ…çš„å®šæ­»å­—ä½“å¤§å°çš„é™åˆ¶ï¼Œå¼ºåˆ¶æ¸²æŸ“æŒ‡å®šå­—ä½“å¤§å°çš„LaTeXç‰‡æ®µ(æ‰å‘ç°è¿™ä¸ªå‡½æ•°å«é‡‘é‡è¿™ä¹ˆè¶³)"
    (interactive)
    (kivnn/org-latex-preview-format)
    (kivnn/org-latex-preview-engine))

  (define-key org-mode-map (kbd "C-1919810")             'kivnn/org-latex-preview)                          ; æ— è§†fontspecåŒ…çš„å®šæ­»å­—ä½“å¤§å°çš„é™åˆ¶ï¼Œå¼ºåˆ¶æ¸²æŸ“æŒ‡å®šå­—ä½“å¤§å°çš„LaTeXç‰‡æ®µ
#+end_src
